<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Fichas Dinámicas</title>
  <style>
.print-preview-landscape #contenedor {
  display: flex;
  flex-wrap: wrap;
  gap: 10mm;
  justify-content: space-around;
  padding: 10mm;
  background: #fff;
}

.print-preview-landscape .tarjeta {
  width: 85mm;
  box-shadow: none;
}
   @media print {
  body {
    margin: 0;
    padding: 0;
  }

  #contenedor {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
    gap: 5mm;
    padding: 10mm;
    width: 100%;
    box-sizing: border-box;
  }

  .tarjeta {
    width: 89mm;
    height: 92.5mm;
    box-sizing: border-box;
    page-break-inside: avoid;
    break-inside: avoid;
    box-shadow: none;
    border: 1px solid #000;
  }
}

    
    body {
  font-family: Arial, sans-serif;
  background: #e6e6e6;
}
.bonificacion-burbuja {
  background-color: #f9f9f9;  /* igual que la tarjeta */
  border: 1px solid #ccc;     /* un borde gris clarito */
  color: #333;                /* texto oscuro para buena lectura */
  border-radius: 12px;
  padding: 6px 12px;
  max-width: 100%;
  font-size: 0.9em;
  white-space: normal;        /* texto con saltos de línea */
  word-wrap: break-word;
  margin-top: 4px;
  display: inline-block;
  box-sizing: border-box;
  
  /* Sombra sutil para la burbuja */
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

#contenedor {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.tarjeta {
  background: #f9f9f9;
  border: 2px solid #333;
  border-radius: 8px;
  width: max-width;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  position: relative;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.stats {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
}

.stat {
  background-color: #333;
  color: #fff;
  padding: 6px 8px;
  font-size: 12px;
  border-radius: 4px;
  text-align: center;
  flex: 1;
  margin: 0 2px;
}

.stat span {
  display: block;
  font-size: 16px;
  margin-top: 4px;
}

.avatar {
  width: 70px;
  height: 70px;
  border: 2px solid #333;
  object-fit: cover;
  border-radius: 4px;
  background: #ccc;
}

.fila {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.bloque {
  flex: 1 1 auto;
  min-width: 120px;
  max-width: 220px;
}

.bloque input, .bloque select {
  width: 100%;
  font-size: 12px;
  padding: 4px;
  border: 1px solid #999;
  border-radius: 4px;
}

.arma-table {
  width: 100%;
  font-size: 11px;
  border-collapse: collapse;
}

.arma-table th, .arma-table td {
  border: 1px solid #333;
  padding: 4px;
  text-align: center;
}

.arma-table thead {
  background: #333;
  color: #fff;
}

.eliminar {
  position: absolute;
  top: 6px;
  right: 6px;
  background: #c00;
  color: #fff;
  border: none;
  padding: 4px 8px;
  font-size: 12px;
  border-radius: 4px;
  cursor: pointer;
}

#botones {
  margin: 16px;
}
.bonificacion {
  width: 100%;
  font-family: inherit;
  font-size: 1em;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 6px;
  box-sizing: border-box;
  overflow-y: auto; /* Mostrar scroll vertical solo si es necesario */
  resize: none; /* evitar que el usuario cambie tamaño */
  background-color: #f9f9f9;
}

button {
  padding: 10px 20px;
  margin: 6px;
  font-size: 14px;
  border: none;
  background: #0077cc;
  color: #fff;
  border-radius: 4px;
  cursor: pointer;
}
   .perk-tag {
  position: relative;
  background: #f4f4f4;
  border-left: 4px solid #777;
  padding: 0.5rem 2rem 0.5rem 1rem;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
    .perk-titulo {
  font-weight: bold;
  margin-bottom: 0.25rem;
}
    .perk-descripcion {
  font-size: 0.95em;
  color: #333;
}

.eliminar-perk {
  position: absolute;
  top: -1rem;
  right: -1rem;
  background: none;
  border: none;
  font-size: 1.2rem;
  color: #900;
  cursor: pointer;
  line-height: 1;
}

.perk-tag .eliminar-perk:hover {
  color: #f00;
}

.lista-perks {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  padding: 0.5rem;
}
    .perkContainer {
  max-height: none;
  overflow: visible;
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}
.perk {
  background-color: #f0f0f0;
  border-radius: 4px;
  padding: 2px 6px;
  font-size: 12px;
}
    .gear-tag {
  border: 1px solid #ccc;
  padding: 6px 10px;
  margin-bottom: 6px;
  border-radius: 5px;
  background-color: #f9f9f9;
  width: 280px;
  font-family: Arial, sans-serif;
}

.gear-nombre {
  font-weight: bold;
  font-size: 14px;
  margin-bottom: 2px;
}

.gear-puntos {
  font-size: 12px;
  color: #555;
  margin-bottom: 4px;
}

.gear-descripcion {
  font-size: 12px;
  color: #777;
  line-height: 1.2;
}
  

  </style>
</head>
<body>

<div id="botones">
  <button onclick="crearTarjeta()">Crear nueva tarjeta</button>
  <button onclick="exportarPDF()">Exportar PDF</button>
  <button onclick="document.body.classList.toggle('print-preview-landscape')">Ver en paisaje</button>

</div>

<div id="contenedor"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


<script>

  
  const expertise = {
  Raiders: "+1 To MA",
  "Counter Terrorism": "Re-roll 1 Shooting Attack per round (must re-roll all dice)",
  "Hostage Rescue": "+1 to each Roll off to see which Warrior Team activates first in the next round",
  "Counter Insurgency": "-1 to the opponent’s Activation Roll once per round (can choose after they’ve rolled)",
  "Covert Ops": "Extend the length and width of the deployment zone by 3",
  Reconnaissance: "Re-roll 1 Armour Save per round (must re-roll all dice)",
};

const especializaciones = {
  Tactician: "Prior Preparation: Any Team Warrior can Re-roll 1 Dice at any time, once per round",
  Medic: "Man Down: Starts with 3 Med Kits. Limited to use 1 Med Kit per round",
  Sniper: "One Shot, One Kill: +1 to Sniper Rifle attack rolls if they haven’t moved during the activation",
};

const armasPrimarias = {
  "Pistol / Revolver": {
    daño: "1",
    alcance: "6”",
    dados: "2",
    armourpiercing: "",
    perks: "If two pistols/revolvers are taken, dual wield and change the Attack Dice characteristic to 4",
    drawback: "",
  },
  //... el resto igual
};

const statsBase = {
  Warrior: { MA: 5, Hearts: 6, HitsOn: "4+", MDP: 5 },
  Enlisted: { MA: 5, Hearts: 3, HitsOn: "5+", MDP: 4 },
  Recruit: { MA: 5, Hearts: 2, HitsOn: "6+", MDP: 3 },
};

let contador = 1;

function crearTarjeta() {
  const tarjeta = document.createElement("div");
  tarjeta.className = "tarjeta";

  tarjeta.innerHTML = `
    <button class="eliminar" onclick="eliminarTarjeta(this)">X</button>
    <div class="fila" style="gap: 4px;">
      <div style="display: flex; flex-direction: column; align-items: center;">
        <img src="" class="avatar" onclick="seleccionarAvatar(this)" alt="Avatar">
        <input type="file" accept="image/*" style="display: none;" onchange="cargarAvatar(this)">
      </div>
      <div style="display: flex; flex-direction: column; justify-content: center; flex: 1;">
        <label style="font-size: 12px;">Nombre:</label>
        <input type="text" value="Recluta ${contador++}" style="font-size: 12px; padding: 4px; border: 1px solid #999; border-radius: 4px; width: 70%;">
      </div>
    </div>

    <div class="stats">
      <div class="stat ma">MA <span>-</span></div>
      <div class="stat hearts">Hearts <span>-</span></div>
      <div class="stat hitsOn">Hits On <span>-</span></div>
      <div class="stat mdp">MDP <span>-</span></div>
    </div>

    <div class="fila">
      <div class="bloque">
        <span class="label">Tipo de Soldado:</span>
        <select onchange="actualizarStatsBase(this)">
          <option value="">-- Elegir --</option>
          <option value="Warrior">Warrior</option>
          <option value="Enlisted">Enlisted</option>
          <option value="Recruit">Recruit</option>
        </select>
      </div>
    </div>

    <div class="fila">
      <div class="bloque">
        <span class="label">Expertise:</span>
        <select onchange="actualizarBonificacionYStats(this)">
          <option value="">-- Elegir --</option>
          ${Object.keys(expertise)
            .map((k) => `<option value="${k}">${k}</option>`)
            .join("")}
        </select>
      </div>
      <div class="bloque">
        <span class="label">Bonificación:</span>
        <div class="bonificacion-burbuja"></div>
      </div>
    </div>

    <div class="fila">
  <div class="bloque" style="flex: 1;">
    <span class="label">Especializaciones:</span>
    <select id="select-especializacion" style="width: 100%;">
      <option value="" disabled selected>Seleccionar especialización...</option>
      ${Object.keys(especializaciones).map(k => `<option value="${k}">${k}</option>`).join('')}
    </select>
  </div>
  <div class="bloque" style="flex: 1;">
    <span class="label">Perks:</span>
    <div class="perks-burbuja-container" style="display:flex; gap:4px; flex-wrap: wrap; min-height: 32px; border: 1px solid #ccc; padding: 4px; border-radius: 4px;"></div>
  </div>
</div>

    <div class="fila">
      <div class="bloque">
        <span class="label">Arma Secundaria:</span>
        <select onchange="actualizarArma(this)">
          <option value="">-- Elegir --</option>
          ${Object.keys(armasPrimarias)
            .map((k) => `<option value="${k}">${k}</option>`)
            .join("")}
        </select>
      </div>
    </div>

    <div style="width: 480px;">
      <span class="label">Stats del arma:</span>
      <table class="arma-table" style="width: 100%; font-size: 11px; border-collapse: collapse;">
        <thead>
          <tr style="background: #000; color: #fff;">
            <th style="width: 10%;">Daño</th>
            <th style="width: 10%;">Alcance</th>
            <th style="width: 10%;">Dados</th>
            <th style="width: 10%;">Armour Piercing</th>
            <th style="width: 30%;">Perks</th>
            <th style="width: 30%;">Drawback</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="dano">-</td>
            <td class="alcance">-</td>
            <td class="dados">-</td>
            <td class="armourpiercing">-</td>
            <td class="perks">-</td>
            <td class="drawback">-</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="tarjeta gear-container">
      <select onchange="agregarGear(this)">
        <option value="" selected disabled>Seleccionar Gear...</option>
        <option value="Rope (1)">Rope (1)</option>
        <option value="Night Vision Goggles (1)">Night Vision Goggles (1)</option>
        <option value="Suppressor (2)">Suppressor (2)</option>
        <option value="Smoke Grenade (2)">Smoke Grenade (2)</option>
        <option value="Frag Grenade (3)">Frag Grenade (3)</option>
        <option value="Flash Bang Grenade (3)">Flash Bang Grenade (3)</option>
        <option value="Advanced Optics (3)">Advanced Optics (3)</option>
        <option value="Med Kit (3)">Med Kit (3)</option>
        <option value="Tactical Body Armour (5)">Tactical Body Armour (5)</option>
        <option value="Drone’s Eye View (5)">Drone’s Eye View (5)</option>
        <option value="Gillie Suit (5)">Gillie Suit (5)</option>
        <option value="RPG (5)">RPG (5)</option>
      </select>

      <ul class="lista-gears" style="font-size: 11px; margin: 0; padding-left: 16px;"></ul>
    </div>

    <div id="total-puntos" style="margin-top: 4px; font-size: 12px; color: #666;">
    Puntos usados totales: 0 / 5
  </div>
</div>
  `;

  document.getElementById("contenedor").appendChild(tarjeta);
}

function eliminarTarjeta(btn) {
  const tarjeta = btn.closest(".tarjeta");
  tarjeta.remove();
}

function seleccionarAvatar(img) {
  const fileInput = img.nextElementSibling;
  fileInput.click();
}

function cargarAvatar(input) {
  const archivo = input.files[0];
  if (!archivo) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    input.previousElementSibling.src = e.target.result;
  };
  reader.readAsDataURL(archivo);
}

function actualizarStatsBase(select) {
  const tarjeta = select.closest(".tarjeta");
  const tipo = select.value;

  if (!tipo) return;

  const stats = statsBase[tipo];
  if (!stats) return;

  tarjeta.querySelector(".stat.ma span").textContent = stats.MA;
  tarjeta.querySelector(".stat.hearts span").textContent = stats.Hearts;
  tarjeta.querySelector(".stat.hitsOn span").textContent = stats.HitsOn;
  tarjeta.querySelector(".stat.mdp span").textContent = stats.MDP;

  actualizarBonificacionYStats(tarjeta.querySelector("select[onchange='actualizarBonificacionYStats(this)']"));
}

function actualizarBonificacionYStats(select) {
  if (!select) return;
  const tarjeta = select.closest(".tarjeta");
  const experiencia = select.value;

  const bonificacionDiv = tarjeta.querySelector(".bonificacion-burbuja");
  if (experiencia && expertise[experiencia]) {
    bonificacionDiv.textContent = expertise[experiencia];
  } else {
    bonificacionDiv.textContent = "";
  }
}

function agregarEspecializacion(select) {
  const tarjeta = select.closest('.tarjeta');
  const perksContainer = tarjeta.querySelector('.perks-burbuja-container');
  const especializacion = select.value;

  if (!especializacion || !especializaciones[especializacion]) return;

  // Evitar agregar la misma especialización más de una vez (comparar perks visibles)
  const perksActuales = [...perksContainer.children].map(div => div.dataset.perk);
  const perksDeEspecializacion = especializaciones[especializacion].split(',').map(p => p.trim());

  const yaAgregados = perksDeEspecializacion.every(perk => perksActuales.includes(perk));
  if (yaAgregados) {
    alert('Esa especialización ya está agregada');
    select.value = '';
    return;
  }

  // Agregar perks como burbujas con botón para eliminar
  perksDeEspecializacion.forEach(perk => {
    if (!perksActuales.includes(perk)) {
      const burbuja = document.createElement('div');
      burbuja.textContent = perk;
      burbuja.dataset.perk = perk;
      burbuja.style.cssText = `
        background: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        cursor: default;
        display: flex;
        align-items: center;
        gap: 6px;
      `;

      const btnEliminar = document.createElement('button');
      btnEliminar.textContent = 'x';
      btnEliminar.style.cssText = `
        background: transparent;
        border: none;
        color: white;
        font-weight: bold;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
      `;
      btnEliminar.onclick = () => {
        perksContainer.removeChild(burbuja);
      };

      burbuja.appendChild(btnEliminar);
      perksContainer.appendChild(burbuja);
    }
  });

  select.value = '';
}


function actualizarArma(select) {
  const tarjeta = select.closest(".tarjeta");
  const arma = select.value;

  const danoTd = tarjeta.querySelector(".arma-table .dano");
  const alcanceTd = tarjeta.querySelector(".arma-table .alcance");
  const dadosTd = tarjeta.querySelector(".arma-table .dados");
  const apTd = tarjeta.querySelector(".arma-table .armourpiercing");
  const perksTd = tarjeta.querySelector(".arma-table .perks");
  const drawbackTd = tarjeta.querySelector(".arma-table .drawback");

  if (arma && armasPrimarias[arma]) {
    const stats = armasPrimarias[arma];
    danoTd.textContent = stats.daño || "-";
    alcanceTd.textContent = stats.alcance || "-";
    dadosTd.textContent = stats.dados || "-";
    apTd.textContent = stats.armourpiercing || "-";
    perksTd.textContent = stats.perks || "-";
    drawbackTd.textContent = stats.drawback || "-";
  } else {
    danoTd.textContent = "-";
    alcanceTd.textContent = "-";
    dadosTd.textContent = "-";
    apTd.textContent = "-";
    perksTd.textContent = "-";
    drawbackTd.textContent = "-";
  }
}

function agregarGear(select) {
  const tarjeta = select.closest('.tarjeta');
  const gearSeleccionado = select.value;
  const listaGears = tarjeta.querySelector('.lista-gears');
  const totalPuntosDiv = tarjeta.querySelector('#total-puntos');

  if (!gearSeleccionado) return;

  // Calcular puntos actuales
  const puntosActuales = [...listaGears.children].reduce((acc, li) => {
    const match = li.textContent.match(/\((\d+)\)/);
    return acc + (match ? parseInt(match[1], 10) : 0);
  }, 0);

  // Extraer puntos del gear seleccionado
  const puntosGear = (() => {
    const match = gearSeleccionado.match(/\((\d+)\)/);
    return match ? parseInt(match[1], 10) : 0;
  })();

  if (puntosActuales + puntosGear > 5) {
    alert('No se pueden superar los 5 puntos en total de gears.');
    select.value = '';
    return;
  }

  // Evitar duplicados
  if ([...listaGears.children].some(li => li.textContent === gearSeleccionado)) {
    alert('Ya agregaste ese gear.');
    select.value = '';
    return;
  }

  const li = document.createElement('li');
  li.textContent = gearSeleccionado;

  // Botón para eliminar gear y actualizar puntos
  const btnEliminar = document.createElement('button');
  btnEliminar.textContent = 'x';
  btnEliminar.style.marginLeft = '10px';
  btnEliminar.onclick = () => {
    listaGears.removeChild(li);
    actualizarPuntosGear(tarjeta);
  };

  li.appendChild(btnEliminar);
  listaGears.appendChild(li);

  actualizarPuntosGear(tarjeta);
  select.value = '';
}

function actualizarPuntosGear(tarjeta) {
  const listaGears = tarjeta.querySelector('.lista-gears');
  const totalPuntosDiv = tarjeta.querySelector('#total-puntos');

  let total = 0;
  [...listaGears.children].forEach(li => {
    const match = li.textContent.match(/\((\d+)\)/);
    if (match) {
      total += parseInt(match[1], 10);
    }
  });

  totalPuntosDiv.textContent = `Puntos usados totales: ${total} / 5`;
}


</script>

</body>
</html>
